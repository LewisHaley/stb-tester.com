<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.9.1: http://docutils.sourceforge.net/" />
<title>stbt(1): A video-capture record/playback testing system -- man page</title>
<meta name="copyright" content="Copyright © 2012 YouView TV Ltd." />
<style type="text/css">

/*
:Author: David Goodger (goodger@python.org)
:Id: $Id: html4css1.css 7434 2012-05-11 21:06:27Z milde $
:Copyright: This stylesheet has been placed in the public domain.

Default cascading style sheet for the HTML output of Docutils.

See http://docutils.sf.net/docs/howto/html-stylesheets.html for how to
customize this style sheet.
*/

/* used to remove borders from tables and images */
.borderless, table.borderless td, table.borderless th {
  border: 0 }

table.borderless td, table.borderless th {
  /* Override padding for "table.docutils td" with "! important".
     The right padding separates the table cells. */
  padding: 0 0.5em 0 0 ! important }

.first {
  /* Override more specific margin styles with "! important". */
  margin-top: 0 ! important }

.last, .with-subtitle {
  margin-bottom: 0 ! important }

.hidden {
  display: none }

a.toc-backref {
  text-decoration: none ;
  color: black }

blockquote.epigraph {
  margin: 2em 5em ; }

dl.docutils dd {
  margin-bottom: 0.5em }

object[type="image/svg+xml"], object[type="application/x-shockwave-flash"] {
  overflow: hidden;
}

/* Uncomment (and remove this text!) to get bold-faced definition list terms
dl.docutils dt {
  font-weight: bold }
*/

div.abstract {
  margin: 2em 5em }

div.abstract p.topic-title {
  font-weight: bold ;
  text-align: center }

div.admonition, div.attention, div.caution, div.danger, div.error,
div.hint, div.important, div.note, div.tip, div.warning {
  margin: 2em ;
  border: medium outset ;
  padding: 1em }

div.admonition p.admonition-title, div.hint p.admonition-title,
div.important p.admonition-title, div.note p.admonition-title,
div.tip p.admonition-title {
  font-weight: bold ;
  font-family: sans-serif }

div.attention p.admonition-title, div.caution p.admonition-title,
div.danger p.admonition-title, div.error p.admonition-title,
div.warning p.admonition-title {
  color: red ;
  font-weight: bold ;
  font-family: sans-serif }

/* Uncomment (and remove this text!) to get reduced vertical space in
   compound paragraphs.
div.compound .compound-first, div.compound .compound-middle {
  margin-bottom: 0.5em }

div.compound .compound-last, div.compound .compound-middle {
  margin-top: 0.5em }
*/

div.dedication {
  margin: 2em 5em ;
  text-align: center ;
  font-style: italic }

div.dedication p.topic-title {
  font-weight: bold ;
  font-style: normal }

div.figure {
  margin-left: 2em ;
  margin-right: 2em }

div.footer, div.header {
  clear: both;
  font-size: smaller }

div.line-block {
  display: block ;
  margin-top: 1em ;
  margin-bottom: 1em }

div.line-block div.line-block {
  margin-top: 0 ;
  margin-bottom: 0 ;
  margin-left: 1.5em }

div.sidebar {
  margin: 0 0 0.5em 1em ;
  border: medium outset ;
  padding: 1em ;
  background-color: #ffffee ;
  width: 40% ;
  float: right ;
  clear: right }

div.sidebar p.rubric {
  font-family: sans-serif ;
  font-size: medium }

div.system-messages {
  margin: 5em }

div.system-messages h1 {
  color: red }

div.system-message {
  border: medium outset ;
  padding: 1em }

div.system-message p.system-message-title {
  color: red ;
  font-weight: bold }

div.topic {
  margin: 2em }

h1.section-subtitle, h2.section-subtitle, h3.section-subtitle,
h4.section-subtitle, h5.section-subtitle, h6.section-subtitle {
  margin-top: 0.4em }

h1.title {
  text-align: center }

h2.subtitle {
  text-align: center }

hr.docutils {
  width: 75% }

img.align-left, .figure.align-left, object.align-left {
  clear: left ;
  float: left ;
  margin-right: 1em }

img.align-right, .figure.align-right, object.align-right {
  clear: right ;
  float: right ;
  margin-left: 1em }

img.align-center, .figure.align-center, object.align-center {
  display: block;
  margin-left: auto;
  margin-right: auto;
}

.align-left {
  text-align: left }

.align-center {
  clear: both ;
  text-align: center }

.align-right {
  text-align: right }

/* reset inner alignment in figures */
div.align-right {
  text-align: inherit }

/* div.align-center * { */
/*   text-align: left } */

ol.simple, ul.simple {
  margin-bottom: 1em }

ol.arabic {
  list-style: decimal }

ol.loweralpha {
  list-style: lower-alpha }

ol.upperalpha {
  list-style: upper-alpha }

ol.lowerroman {
  list-style: lower-roman }

ol.upperroman {
  list-style: upper-roman }

p.attribution {
  text-align: right ;
  margin-left: 50% }

p.caption {
  font-style: italic }

p.credits {
  font-style: italic ;
  font-size: smaller }

p.label {
  white-space: nowrap }

p.rubric {
  font-weight: bold ;
  font-size: larger ;
  color: maroon ;
  text-align: center }

p.sidebar-title {
  font-family: sans-serif ;
  font-weight: bold ;
  font-size: larger }

p.sidebar-subtitle {
  font-family: sans-serif ;
  font-weight: bold }

p.topic-title {
  font-weight: bold }

pre.address {
  margin-bottom: 0 ;
  margin-top: 0 ;
  font: inherit }

pre.literal-block, pre.doctest-block, pre.math, pre.code {
  margin-left: 2em ;
  margin-right: 2em }

pre.code .ln { /* line numbers */
  color: grey;
}

.code {
  background-color: #eeeeee
}

span.classifier {
  font-family: sans-serif ;
  font-style: oblique }

span.classifier-delimiter {
  font-family: sans-serif ;
  font-weight: bold }

span.interpreted {
  font-family: sans-serif }

span.option {
  white-space: nowrap }

span.pre {
  white-space: pre }

span.problematic {
  color: red }

span.section-subtitle {
  /* font-size relative to parent (h1..h6 element) */
  font-size: 80% }

table.citation {
  border-left: solid 1px gray;
  margin-left: 1px }

table.docinfo {
  margin: 2em 4em }

table.docutils {
  margin-top: 0.5em ;
  margin-bottom: 0.5em }

table.footnote {
  border-left: solid 1px black;
  margin-left: 1px }

table.docutils td, table.docutils th,
table.docinfo td, table.docinfo th {
  padding-left: 0.5em ;
  padding-right: 0.5em ;
  vertical-align: top }

table.docutils th.field-name, table.docinfo th.docinfo-name {
  font-weight: bold ;
  text-align: left ;
  white-space: nowrap ;
  padding-left: 0 }

h1 tt.docutils, h2 tt.docutils, h3 tt.docutils,
h4 tt.docutils, h5 tt.docutils, h6 tt.docutils {
  font-size: 100% }

ul.auto-toc {
  list-style-type: none }

</style>
<style type="text/css">

/*
:Author: David Röthlisberger <david@rothlis.net>
:Copyright: This stylesheet has been placed in the public domain.

Stylesheet customisations for stb-tester man page generated with docutils.
*/

.document       { margin: 1em auto; max-width: 700px; }
body,
h2.subtitle     { font-family: verdana, helvetica, sans-serif;
                  font-size: 12pt; line-height: 1.5; }
h1, h2          { font-family: georgia, "times new roman", serif; }
h1.title        { font-size: 36pt; line-height: 1; margin: 0 0 0.5em; }
h2.subtitle     { font-size: 12pt; line-height: 1.5; margin: 0 0 1.5em;
                  font-style: italic; font-weight: normal; }
h1              { font-size: 18pt; line-height: 1; margin: 1em 0; }
h2              { font-size: 14pt; line-height: 1.28; margin: 1.28em 0; }

td.option-group { padding-top: .5em; padding-bottom: .5em; font-weight: bold; }
tr:first-child td.option-group { padding-top: 0; }

</style>
</head>
<body>
<div class="document" id="stbt">
<h1 class="title">stbt</h1>
<h2 class="subtitle" id="a-record-playback-testing-system-for-set-top-boxes">A record + playback testing system for set-top boxes</h2>
<table class="docinfo" frame="void" rules="none">
<col class="docinfo-name" />
<col class="docinfo-content" />
<tbody valign="top">
<tr><th class="docinfo-name">Copyright:</th>
<td>Copyright © 2012 YouView TV Ltd.</td></tr>
<tr class="field"><th class="docinfo-name">License:</th><td class="field-body">LGPL v2.1 or any later version (see LICENSE file for details)</td>
</tr>
<tr><th class="docinfo-name">Version:</th>
<td>0.3</td></tr>
</tbody>
</table>
<div class="section" id="synopsis">
<h1>SYNOPSIS</h1>
<p>stbt record [options]</p>
<p>stbt run [options] [script]</p>
</div>
<div class="section" id="description">
<h1>DESCRIPTION</h1>
<p><strong>stbt record</strong> will record a test case by listening for remote-control
keypresses, taking screenshots from the set-top box as it goes.</p>
<p>You then (manually) crop the screenshots to the region of interest.</p>
<p>(Optionally) you manually edit the generated test script, which will look
something like this:</p>
<pre class="literal-block">
press(&quot;MENU&quot;)
wait_for_match(&quot;Guide.png&quot;)
press(&quot;OK&quot;)
wait_for_match(&quot;BBC One.png&quot;)
</pre>
<p><strong>stbt run</strong> will play back the given test script, returning an exit status of
success or failure for easy integration with your existing test reporting
system.</p>
</div>
<div class="section" id="options">
<h1>OPTIONS</h1>
<div class="section" id="global-options">
<h2>Global options</h2>
<table class="docutils option-list" frame="void" rules="none">
<col class="option" />
<col class="description" />
<tbody valign="top">
<tr><td class="option-group" colspan="2">
<kbd><span class="option">--control=<var>&lt;uri&gt;</var></span></kbd></td>
</tr>
<tr><td>&nbsp;</td><td><p class="first">A remote control to use for controlling the set top box. <cite>uri</cite> can be:</p>
<dl class="last docutils">
<dt>lirc:&lt;lircd_socket&gt;:&lt;remote_control_name&gt;</dt>
<dd>A hardware infrared emitter controlled by the lirc (Linux Infrared Remote
Control) daemon. <cite>lircd_socket</cite> defaults to <cite>/var/run/lirc/lircd</cite>.
<cite>remote_control_name</cite> is the name of a remote-control specification in
lircd.conf.</dd>
<dt>vr:&lt;hostname&gt;:&lt;port&gt;</dt>
<dd>A &quot;virtual remote&quot; that communicates with the set-top box over TCP.
Requires a virtual remote listener (which we haven't released yet) running
on the stb.</dd>
<dt>none</dt>
<dd>Ignores key press commands.</dd>
<dt>test</dt>
<dd>Used by the selftests to change the input video stream. Only works with
<cite>--source-pipeline=videotestsrc</cite>. A script like <cite>press(&quot;18&quot;)</cite> will change
videotestsrc's pattern property (see <cite>gst-inspect videotestsrc</cite>).</dd>
</dl>
</td></tr>
<tr><td class="option-group" colspan="2">
<kbd><span class="option">--source-pipeline=<var>&lt;pipeline&gt;</var></span></kbd></td>
</tr>
<tr><td>&nbsp;</td><td><p class="first">A gstreamer pipeline providing a video stream to use as video output from the
set-top box under test.  For the Hauppauge HD PVR use:</p>
<pre class="last literal-block">
v4l2src device=/dev/video0 ! mpegtsdemux ! video/x-h264 ! decodebin
</pre>
</td></tr>
<tr><td class="option-group" colspan="2">
<kbd><span class="option">--sink-pipeline=<var>&lt;pipeline&gt;</var></span></kbd></td>
</tr>
<tr><td>&nbsp;</td><td>A gstreamer pipeline to use for video output, like <cite>xvimagesink</cite>.</td></tr>
</tbody>
</table>
</div>
<div class="section" id="additional-options-to-stbt-record">
<h2>Additional options to stbt record</h2>
<table class="docutils option-list" frame="void" rules="none">
<col class="option" />
<col class="description" />
<tbody valign="top">
<tr><td class="option-group" colspan="2">
<kbd><span class="option">--control-recorder=<var>&lt;uri&gt;</var></span></kbd></td>
</tr>
<tr><td>&nbsp;</td><td><p class="first">The source of remote control presses.  <cite>uri</cite> can be:</p>
<dl class="last docutils">
<dt>lirc:&lt;lircd_socket&gt;:&lt;remote_control_name&gt;</dt>
<dd>A hardware infrared receiver controlled by the lirc (Linux Infrared Remote
Control) daemon. <cite>lircd_socket</cite> and <cite>remote_control_name</cite> are as for
<cite>--control</cite>.</dd>
<dt>vr:&lt;hostname&gt;:&lt;port&gt;</dt>
<dd>Listens on the socket &lt;hostname&gt;:&lt;port&gt; for a connection and reads a
&quot;virtual remote&quot; stream (which we haven't documented yet, but we'll
probably change it soon to be compatible with LIRC's protocol).</dd>
<dt>file://&lt;filename&gt;</dt>
<dd>Reads remote control keypresses from a newline-separated list of key names.
For example, <cite>file:///dev/stdin</cite> to use the keyboard as the remote control
input.</dd>
</dl>
</td></tr>
<tr><td class="option-group" colspan="2">
<kbd><span class="option">-o <var>&lt;filename&gt;</var></span>, <span class="option">--output-filename=<var>&lt;filename&gt;</var></span></kbd></td>
</tr>
<tr><td>&nbsp;</td><td>The file to write the generated test script to.</td></tr>
</tbody>
</table>
</div>
</div>
<div class="section" id="configuration">
<h1>CONFIGURATION</h1>
<p>All parameters that can be passed to the stbt tools can now also be specified in
configuration files.  Configuration is searched for in (latter taking precedence
over earlier):</p>
<ol class="arabic simple">
<li>/etc/stbt/stbt.conf</li>
<li>~/.config/stbt/stbt.conf</li>
<li>$STBT_CONFIG_FILE</li>
<li>$PWD/stbt.conf</li>
</ol>
<p>These files are simple ini files with the form:</p>
<pre class="literal-block">
[global]
    source_pipeline=videotestsrc
    control=None
[run]
    script=test.py
[record]
    output_file=test.py
    control_recorder=file:///dev/stdin
</pre>
<p>Each key corresponds to a command line option with hyphens replaced with
underscores.  Configuration items in the 'global' section will be passed to
all tools; this can be overridden in the sections corresponding to each of the
individual tools.</p>
</div>
<div class="section" id="hardware-requirements">
<h1>HARDWARE REQUIREMENTS</h1>
<p>The test rig consists of a Linux server, with:</p>
<ul class="simple">
<li>A video-capture card (for capturing the output from the system under test)</li>
<li>An infrared receiver (for recording test cases)</li>
<li>An infrared emitter (for controlling the system under test)</li>
</ul>
<div class="section" id="video-capture-card">
<h2>Video capture card</h2>
<p>You'll need a capture card with drivers supporting the V4L2 API
(Video-for-Linux 2). We recommend a capture card with mature open-source
drivers, preferably drivers already present in recent versions of the Linux
kernel.</p>
<p>The Hauppauge HD PVR works well (and works out of the box on recent versions of
Fedora), though it doesn't support 1080p. If you need an HDCP stripper, try the
HD Fury III.</p>
</div>
<div class="section" id="infra-red-emitter-and-receiver">
<h2>Infra-red emitter and receiver</h2>
<p>An IR emitter+receiver such as the RedRat3, plus a LIRC configuration file
with the key codes for your set-top box's remote control.</p>
</div>
<div class="section" id="using-software-components-instead">
<h2>Using software components instead</h2>
<p>If you don't mind instrumenting the system under test, you don't even need the
above hardware components.</p>
<p>stb-tester uses gstreamer, an open source multimedia framework. Instead of a
video-capture card you can use any gstreamer video-source element. For example:</p>
<ul class="simple">
<li>If you run tests against a VM running the set-top box software instead
of a physical set-top box, you could use the ximagesrc gstreamer
element to capture video from the VM's X Window.</li>
<li>If your set-top box uses DirectFB, you could install the (not yet written)
DirectFBSource gstreamer element on the set-top box to stream video to a
tcpclientsrc or tcpserversrc gstreamer element on the test rig.</li>
</ul>
<p>Instead of a hardware infra-red receiver + emitter, you can use a software
equivalent (for example a server running on the set-top box that listens on
a TCP socket instead of listening for infra-red signals, and your own
application for emulating remote-control keypresses). Using a software remote
control avoids all issues of IR interference in rigs testing multiple set-top
boxes at once.</p>
</div>
<div class="section" id="linux-server">
<h2>Linux server</h2>
<p>We expect that an 8-core machine will be able to drive 4 set-top boxes
simultaneously with at least 1 frame per second per set-top box.
(TODO: Assuming enough bandwidth on the USB bus -- need to test this).</p>
</div>
</div>
<div class="section" id="software-requirements">
<h1>SOFTWARE REQUIREMENTS</h1>
<ul>
<li><p class="first">A Unixy operating system (we have only tested on Linux; gstreamer and OpenCV
allegedly work on BSD, Mac OS X, and possibly Windows with MingW/MSys; but
building gst-plugins-bad, below, can be tricky).</p>
</li>
<li><p class="first">Drivers for any required hardware components</p>
</li>
<li><p class="first">gstreamer 0.10 (multimedia framework) + gst-plugins-base + gst-plugins-good.</p>
</li>
<li><p class="first">python (we have tested with 2.6 and 2.7) + pygst + pygtk2 (+ nose for the
self-tests).</p>
</li>
<li><p class="first">OpenCV (image processing library) version &gt;= 2.0.0 and &lt;= 2.3.1
(the version restrictions are imposed by gst-plugins-bad).</p>
</li>
<li><p class="first">gst-plugins-bad (for the gstreamer wrappers around OpenCV)
built from source from the head of the 0.10 branch, with the patches from
<a class="reference external" href="https://bugzilla.gnome.org/show_bug.cgi?id=678485">https://bugzilla.gnome.org/show_bug.cgi?id=678485</a>
(until such time as the patches are accepted upstream).</p>
<p>A github repo with the same patches applied is available at
<a class="reference external" href="https://github.com/drothlis/gst-plugins-bad">https://github.com/drothlis/gst-plugins-bad</a> (branch templatematch-fixes).</p>
</li>
<li><p class="first">For the Hauppauge video capture device you'll need the gstreamer-ffmpeg
package (e.g. from the rpmfusion-free repository) for H.264 decoding.</p>
</li>
</ul>
</div>
<div class="section" id="installing-from-source">
<h1>INSTALLING FROM SOURCE</h1>
<p>Run &quot;make install&quot; from the stb-tester source directory.</p>
<p>Requires python-docutils (for building the documentation).</p>
</div>
<div class="section" id="setup-tips">
<h1>SETUP TIPS</h1>
<p>Use &quot;gst-inspect templatematch&quot; to check that gstreamer can find the
templatematch element. You may need to set GST_PLUGIN_PATH to point
where you installed gst-plugins-bad.</p>
<p>Run tests/run-tests.sh to verify that your gstreamer + OpenCV installation is
working correctly.</p>
<p>If you plan to use real infrared emitters/receivers, use lirc's irsend(1) and
ircat(1), respectively, to test your lirc setup before integrating with
stb-tester.</p>
</div>
<div class="section" id="test-script-format">
<h1>TEST SCRIPT FORMAT</h1>
<p>The test scripts produced and run by <strong>stbt record</strong> and <strong>stbt run</strong>,
respectively, are actually python scripts, so you can use the full power of
python. Don't get too carried away, though; aim for simplicity, readability,
and maintainability.</p>
<p>The following functions are available (the &quot;keyword arguments&quot; like
<cite>timeout_secs</cite> are optional, and default to the value shown):</p>
<pre class="literal-block">
press(&quot;KEY NAME&quot;)

wait_for_match(&quot;filename.png&quot;, timeout_secs=10, certainty=0.99)

press_until_match(&quot;KEY NAME&quot;, &quot;filename.png&quot;,
                  interval_secs=3, max_presses=10, certainty=0.99)
</pre>
</div>
<div class="section" id="test-script-best-practices">
<h1>TEST SCRIPT BEST PRACTICES</h1>
<ul class="simple">
<li>When cropping images to be matched by a test case, you must select a region
that will <em>not</em> be present when the test case fails, and that does <em>not</em>
contain <em>any</em> elements that might be absent when the test case succeeds. For
example, you must not include any part of a live TV stream (which will be
different each time the test case is run), nor translucent menu overlays with
live TV showing through.</li>
<li>Don't crop tiny images: Instead of selecting just the text in a menu button,
select the whole button. (Larger images provide a greater gap between the
&quot;match certainty&quot; reported for non-matching vs. matching images, which makes
for more robust tests).</li>
</ul>
</div>
<div class="section" id="see-also">
<h1>SEE ALSO</h1>
<ul class="simple">
<li><a class="reference external" href="http://github.com/drothlis/stb-tester">http://github.com/drothlis/stb-tester</a></li>
</ul>
</div>
<div class="section" id="authors">
<h1>AUTHORS</h1>
<ul class="simple">
<li>Will Manley &lt;<a class="reference external" href="mailto:will&#64;williammanley.net">will&#64;williammanley.net</a>&gt;</li>
<li>David Rothlisberger &lt;<a class="reference external" href="mailto:david&#64;rothlis.net">david&#64;rothlis.net</a>&gt;</li>
</ul>
</div>
</div>
</body>
</html>
